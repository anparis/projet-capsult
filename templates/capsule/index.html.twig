{% extends 'base.html.twig' %}

{% block meta %}
<meta
  name="description"
  content="{{app.user.slug}}'s capsule">
{% endblock %}

{% block title %}Capsule index{% endblock %}

{% block body %}
  <div class="br-r5 m-a">
    {% if app.user is same as (user) %}
      <a href="{{path('capsule_edit',{'id':capsule.id})}}">/{{capsule.title}}</a>
    {% else %}
      <a href="{{path('capsule_show',{'id':capsule.id})}}">/{{capsule.title}}</a>
    {% endif %}
  </div>
  {% if app.user is same as (user) %}
		<a href="{{path('add_capsule', {'id':capsule.id})}}">
    <button class="add-btn">
      + Ajouter une capsule
    </button>
    </a>
  {% endif %}
  <br>
  <p>Collaborateurs :
  {% for collaborator in capsule.collaborators %}
    {{collaborator.slug}}
  {% endfor %}
  </p>
  <br>
  {{ include ('capsule/_like.html.twig')}}
  <br>
  <a href="{{path('profile_index',{'slug':user.slug})}}"><- capsules</a>
  <br>
	<main>
    {{ include ('capsule/_like_list.html.twig')}}
    {{ include ('capsule/_status.html.twig')}}

    <br><br>
    <button class="" data-action="likes">explorer</button>
    {{ include ('capsule/_explore.html.twig')}}
		<div class="box-constraint">
			<div class="bloc-container">
        {% if app.user is same as (user) or app.user in capsule.collaborators %}
				<div class="bloc-item afs">
					<div class="addBlock">
						<form id="ab-form" action="{{path('capsule_add_bloc', {'id':capsule.id})}}" method="POST" enctype="multipart/form-data">
							<div class="ab-text">
								Collez un lien URL, écrivez directement du texte ou choisissez une image
								<input class="font-s" type="file" name="image">
							</div>
							<textarea class="ab-textarea" name="txt_input" class="addBlock-textarea"></textarea>
							<input type="hidden" name="token" value="{{ csrf_token('add-bloc') }}"/>
							<button type="submit" name="submit">-> Ajouter le Bloc</button>
						</form>
					</div>
				</div>
        {% endif %}
        {% if blocs %}
				{% for key, bloc in blocs %}
					<div class="bloc-item">
            {% if bloc['bloc'].lien %}
            <div class="link-wrapper">
            <span class="bloc-url">
              <a class="url-wrap" href="{{ bloc['bloc'].lien.url }}" target="_blank">
                <button class="inline-btn">
                  <img class="arrow-icon" src="{{asset('/logos/arrow-icon.svg')}}">
                </button>
              </a>
            </span>
            {% endif %}
            {% if not bloc['bloc'].capsule %}
						<a href="{{path('app_bloc_show', {'bloc_id':bloc['bloc'].id, 'capsule_slug':capsule.slug })}}" class="connection-container">
            {% elseif bloc['bloc'].capsule.user == app.user or app.user in capsule.collaborators %}
            <a href="{{path('app_bloc_edit', {'bloc_id':bloc['bloc'].id, 'capsule_slug':capsule.slug })}}" class="connection-container">
            {% else %}
						<a href="{{path('app_bloc_show', {'bloc_id':bloc['bloc'].id, 'capsule_slug':capsule.slug })}}" class="connection-container">
            {% endif %}
								{% if bloc['bloc'].content | escape %}
							  <div class="bloc-txt">
									<p>{{ bloc['bloc'].content|striptags|length > 300 ? bloc['bloc'].content|striptags|slice(0,300) ~ '...' : bloc['bloc'].content }}</p>
							  </div>
								{% elseif bloc['bloc'].type is same as ("Image") %}
							  <div class="bloc-img">
									<img src="{{ uploaded_asset(bloc['bloc'].image.nomFichier) | imagine_filter('my_thumb') }}" alt="{{ bloc['bloc'].title ? loc['bloc'].title : 'uploaded image'}}" loading="lazy">
							  </div>
								{% else %}
							  <div class="bloc-link">
                  {% if bloc['bloc'].lien.thumb %}
                    <img class="link-thumb" src="{{ bloc['bloc'].lien.thumb }}" alt="link thumb" loading="lazy">
                  {% elseif bloc['bloc'].lien.url matches "/\.(jpg|jpeg|gif|png|tiff|bmp)$/" %}
                    <img src="{{bloc['bloc'].lien.url}}" alt="">
                  {% else %}
                      <p>{{bloc['bloc'].lien.url}}</p>
                  {% endif %}
							  </div>
								{% endif %}
						    </a>
                {% if bloc['bloc'].lien %}
                </div>
                {% endif %}
                {% if app.user %}
                  <a href="{{path('capsules_connection', {'user_slug':app.user.slug,'capsule_slug':capsule.slug, 'id':bloc['bloc'].id})}}">-> Connecter</a>
                {% else %}
                  <a href="{{path('app_register')}}">-> Connecter</a>
                {% endif %}
                {% if bloc['bloc'].capsule %}
                  {% if capsule.user.id == bloc['bloc'].capsule.user.id %}
                    <p>ajouté par {{bloc['bloc'].user.username}}</p>
                  {% else %}
                    <p>connecté par {{bloc['bloc'].user.username}}</p>
                  {% endif %}
                {% else %}
                  <p>connecté par {{app.user.username}}</p>
                {% endif %}
					</div>
				{% endfor %}
        {% endif %}
			</div>
		</div>
	</main>
    
{% endblock %}
